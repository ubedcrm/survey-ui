<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Survey Customer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Arial, sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:30px
}
h1{margin-bottom:10px}
select{padding:6px}

.cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px;
  margin:20px 0
}
.card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,.08);
  text-align:center
}

.chart-box{
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,.08);
  margin-bottom:20px
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:12px;
  overflow:hidden
}
th,td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:center
}
th{
  background:#ff5ca8;
  color:#fff
}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard Survey Customer</h1>

Filter Bulan:
<select id="bulan"></select>

<div class="cards">
  <div class="card">
    <h3>Kepuasan Produk</h3>
    <b id="avgProduk">-</b>
  </div>
  <div class="card">
    <h3>Layanan CS</h3>
    <b id="avgCS">-</b>
  </div>
  <div class="card">
    <h3>Layanan WA</h3>
    <b id="avgWA">-</b>
  </div>
</div>

<div class="chart-box">
  <canvas id="chart" height="120"></canvas>
</div>

<table>
<thead>
<tr>
  <th>Nama</th>
  <th>HP</th>
  <th>Alamat</th>
  <th>Produk</th>
  <th>CS</th>
  <th>WA</th>
  <th>Tanggal</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbwO6JUOxrskZJ3o9raQOjC9i6vHmSjXa0uve22RSSkSIYt4CTIy9PNPJ2A1wVHSG_a2vw/exec?token=UBED_ADMIN_2026";

let rawData = [];
let chart;

fetch(API_URL)
.then(r => r.json())
.then(d => {
  rawData = Array.isArray(d) ? d : [];
  initFilter();
  render();
});

function initFilter(){
  const sel = document.getElementById("bulan");
  sel.innerHTML = `<option value="all">Semua</option>`;

  [...new Set(rawData.map(x=>{
    const t = new Date(x.timestamp);
    return t.getMonth();
  }))].forEach(m=>{
    sel.innerHTML += `<option value="${m}">Bulan ${m+1}</option>`;
  });

  sel.onchange = render;
}

function render(){
  const m = document.getElementById("bulan").value;
  const data = m==="all"
    ? rawData
    : rawData.filter(x=>new Date(x.timestamp).getMonth()==m);

  document.getElementById("avgProduk").innerText = avg(data,"kepuasan_produk");
  document.getElementById("avgCS").innerText = avg(data,"layanan_cs");
  document.getElementById("avgWA").innerText = avg(data,"layanan_wa");

  const tbody = document.getElementById("tbody");
  tbody.innerHTML="";
  data.forEach(x=>{
    tbody.innerHTML += `
    <tr>
      <td>${x.nama}</td>
      <td>${x.hp}</td>
      <td>${x.alamat}</td>
      <td>${x.kepuasan_produk}</td>
      <td>${x.layanan_cs}</td>
      <td>${x.layanan_wa}</td>
      <td>${new Date(x.timestamp).toLocaleDateString()}</td>
    </tr>`;
  });

  drawChart(data);
}

function avg(data,key){
  if(!data.length) return "-";
  return (
    data.reduce((a,b)=>a+Number(b[key]),0) / data.length
  ).toFixed(1);
}

function drawChart(data){
  const ctx = document.getElementById("chart");
  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Produk","CS","WA"],
      datasets:[{
        data:[
          avg(data,"kepuasan_produk"),
          avg(data,"layanan_cs"),
          avg(data,"layanan_wa")
        ],
        backgroundColor:["#ff5ca8","#ff8ac1","#ffc0dd"],
        barThickness: 22,        // ðŸ”¥ TIPIS
        maxBarThickness: 28,
        borderRadius: 8
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false}
      },
      scales:{
        y:{
          beginAtZero:true,
          max:5
        }
      }
    }
  });
}
</script>

</body>
</html>
