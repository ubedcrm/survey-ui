<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Survey | PaddyID</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:30px
}
h1{margin-bottom:6px}
select{padding:6px 10px}

.cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px;
  margin:20px 0
}
.card{
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 2px 12px rgba(0,0,0,.08);
  text-align:center
}

/* INSIGHT */
#insightBox{
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 2px 12px rgba(0,0,0,.08);
  margin-bottom:20px
}
.insight-good{color:#2ecc71;font-weight:bold}
.insight-warn{color:#f1c40f;font-weight:bold}
.insight-bad{color:#e74c3c;font-weight:bold}

/* CHART */
.chart-box{
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 2px 12px rgba(0,0,0,.08);
  margin-bottom:20px
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:14px;
  overflow:hidden
}
th,td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:center;
  font-size:14px
}
th{
  background:#ff5ca8;
  color:#fff
}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard Survey Customer</h1>

Filter Bulan:
<select id="bulan"></select>

<div class="cards">
  <div class="card">
    <p>Kepuasan Produk</p>
    <h2 id="avgProduk">-</h2>
  </div>
  <div class="card">
    <p>Layanan CS</p>
    <h2 id="avgCS">-</h2>
  </div>
  <div class="card">
    <p>Layanan WA</p>
    <h2 id="avgWA">-</h2>
  </div>
</div>

<!-- INSIGHT -->
<div id="insightBox">
  <h3>ðŸ“Œ Insight Otomatis</h3>
  <p id="insightText">-</p>
</div>

<div class="chart-box">
  <canvas id="chart" height="120"></canvas>
</div>

<table>
<thead>
<tr>
  <th>Nama</th>
  <th>HP</th>
  <th>Alamat</th>
  <th>Produk</th>
  <th>CS</th>
  <th>WA</th>
  <th>Tanggal</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
/* ===============================
   CONFIG
================================ */
const API_URL =
"https://script.google.com/macros/s/AKfycbwO6JUOxrskZJ3o9raQOjC9i6vHmSjXa0uve22RSSkSIYt4CTIy9PNPJ2A1wVHSG_a2vw/exec";

let rawData = [];
let chart;

/* ===============================
   FETCH DATA
================================ */
fetch(API_URL)
  .then(r => r.json())
  .then(res => {
    rawData = Array.isArray(res) ? res : [];
    initFilter();
    render();
  });

/* ===============================
   FILTER BULAN
================================ */
function initFilter(){
  const sel = document.getElementById("bulan");
  sel.innerHTML = `<option value="all">Semua</option>`;

  const months = [...new Set(
    rawData.map(d => new Date(d.timestamp).toISOString().slice(0,7))
  )];

  months.forEach(m=>{
    const o = document.createElement("option");
    o.value = m;
    o.textContent = m;
    sel.appendChild(o);
  });

  sel.onchange = render;
}

/* ===============================
   RENDER
================================ */
function render(){
  const m = document.getElementById("bulan").value;
  const data = m==="all"
    ? rawData
    : rawData.filter(d =>
        new Date(d.timestamp).toISOString().startsWith(m)
      );

  document.getElementById("avgProduk").innerText = avg(data,"kepuasan_produk");
  document.getElementById("avgCS").innerText = avg(data,"layanan_cs");
  document.getElementById("avgWA").innerText = avg(data,"layanan_wa");

  renderInsight(data);
  renderTable(data);
  drawChart(data);
}

/* ===============================
   TABLE
================================ */
function renderTable(data){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML="";
  data.forEach(d=>{
    tbody.innerHTML += `
      <tr>
        <td>${d.nama}</td>
        <td>${d.hp}</td>
        <td>${d.alamat}</td>
        <td>${d.kepuasan_produk}</td>
        <td>${d.layanan_cs}</td>
        <td>${d.layanan_wa}</td>
        <td>${new Date(d.timestamp).toLocaleDateString()}</td>
      </tr>
    `;
  });
}

/* ===============================
   AVERAGE
================================ */
function avg(data,key){
  if(!data.length) return "-";
  return (
    data.reduce((a,b)=>a+Number(b[key]||0),0)/data.length
  ).toFixed(1);
}

/* ===============================
   INSIGHT
================================ */
function insight(label,val){
  if(val>=4.5) return `ðŸŸ¢ ${label} sangat baik`;
  if(val>=4) return `ðŸŸ¡ ${label} cukup baik`;
  return `ðŸ”´ ${label} perlu ditingkatkan`;
}

function renderInsight(data){
  const el = document.getElementById("insightText");
  if(!data.length){
    el.innerText = "-";
    return;
  }

  const p = avg(data,"kepuasan_produk");
  const cs = avg(data,"layanan_cs");
  const wa = avg(data,"layanan_wa");

  let cls = "insight-good";
  if(p<4 || cs<4 || wa<4) cls="insight-bad";
  else if(p<4.5 || cs<4.5 || wa<4.5) cls="insight-warn";

  el.className = cls;
  el.innerHTML = [
    insight("Produk",p),
    insight("CS",cs),
    insight("WA",wa)
  ].join("<br>");
}

/* ===============================
   CHART (TIPIS)
================================ */
function drawChart(data){
  const ctx = document.getElementById("chart");
  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Produk","CS","WA"],
      datasets:[{
        data:[
          avg(data,"kepuasan_produk"),
          avg(data,"layanan_cs"),
          avg(data,"layanan_wa")
        ],
        backgroundColor:["#ff5ca8","#ff8ac1","#ffc0dd"],
        barThickness:22,
        maxBarThickness:28,
        borderRadius:8
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        y:{beginAtZero:true,max:5}
      }
    }
  });
}
</script>

</body>
</html>
